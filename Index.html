<!DOCTYPE html>

<html lang="en-US">
<head>
    <meta charset="utf-8">
    <title>Japan Geography Explorer</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #side-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            margin: 10px;
            border-radius: 4px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h2 {
            margin-top: 0;
            color: #333;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
            border: 1px solid #ddd;
            background: white;
            margin-top: 10px;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        button {
            margin-bottom: 10px;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #45a049;
        }

        /* Hide side panel when screen width is less than 1024px */
        @media screen and (max-width: 1024px) {
            #side-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="side-panel">
        <h2>Japan Geography Data</h2>
        <button>Sort by Population</button>
        <button id="toggleEQ">Hide Earthquakes</button>
        <table id="dataTable">
            <tr>
                <th>Prefecture</th>
                <th>Population</th>
                <th>Area (km²)</th>
            </tr>
        </table>
    </div>
    <script>
        console.log('Starting map initialization...');
        mapboxgl.accessToken = 'pk.eyJ1IjoiY295c21heCIsImEiOiJjbWhjeGVxbWQxZjV3MmpwcjlsNGNoc2pkIn0.lN8fMUCO0-cVKDiQW_G7tg';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            zoom: 5,
            center: [138, 38]
        });

        map.on('load', () => {
            console.log('Map loaded successfully');
        });

        map.on('error', (e) => {
            console.error('Map error:', e);
        });

        map.addControl(new mapboxgl.NavigationControl());

        async function loadData() {
            // Load both datasets before map setup
            console.log('Starting data fetch...');
            let response, earthquakes, japan;
            
            try {
                // Load Japan boundary data
                console.log('Fetching Japan data from:', 'assets/japan.json');
                response = await fetch('assets/japan.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                japan = await response.json();
                console.log('Japan data loaded successfully:', japan.features ? japan.features.length + ' features' : 'No features');

                // Load earthquake data
                console.log('Fetching earthquake data from:', 'assets/earthquakes.geojson');
                response = await fetch('assets/earthquakes.geojson');
                if (!response.ok) {
                    throw new Error(`HTTP error loading earthquakes! status: ${response.status}`);
                }
                earthquakes = await response.json();
                console.log('Earthquakes data loaded successfully:', earthquakes.features ? earthquakes.features.length + ' features' : 'No features');
            } catch (error) {
                console.error('Error loading data:', error);
                return;
            }

            map.on('load', async () => {
                console.log('map load event fired (index.html)');
                // Add Japan boundary source
                map.addSource('japan', {
                    type: 'geojson',
                    data: japan
                });

                // Add fill layer
                map.addLayer({
                    'id': 'japan-fill',
                    'type': 'fill',
                    'source': 'japan',
                    'paint': {
                        'fill-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'population'],
                            0, '#fee5d9',
                            1000000, '#fcae91',
                            5000000, '#fb6a4a',
                            10000000, '#de2d26',
                            20000000, '#a50f15'
                        ],
                        'fill-opacity': 0.7
                    }
                });

                // Add outline layer
                map.addLayer({
                    'id': 'japan-outline',
                    'type': 'line',
                    'source': 'japan',
                    'paint': {
                        'line-color': '#000',
                        'line-width': 1
                    }
                });

                // Add hover effect
                map.on('mousemove', 'japan-fill', (e) => {
                    if (e.features.length > 0) {
                        map.getCanvas().style.cursor = 'pointer';
                    }
                });

                map.on('mouseleave', 'japan-fill', () => {
                    map.getCanvas().style.cursor = '';
                });

                // Add popup on click
                map.on('click', 'japan-fill', (e) => {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`
                                <h3>${feature.properties.name}</h3>
                                <p>Population: ${feature.properties.population.toLocaleString()}</p>
                                <p>Area: ${feature.properties.area.toLocaleString()} km²</p>
                            `)
                            .addTo(map);
                    }
                });

                // Populate table
                const table = document.getElementById('dataTable');
                japan.features.forEach(feature => {
                    const row = table.insertRow(-1);
                    row.insertCell(0).textContent = feature.properties.name;
                    row.insertCell(1).textContent = feature.properties.population.toLocaleString();
                    row.insertCell(2).textContent = feature.properties.area.toLocaleString();
                });

                // Load earthquakes dataset and add as a separate layer (async/await)
                try {
                    const eqResp = await fetch('assets/earthquakes.geojson');
                    const eqData = await eqResp.json();

                    // Add earthquakes source
                    map.addSource('earthquakes', {
                        type: 'geojson',
                        data: eqData
                    });

                    // Add earthquake circles layer
                    map.addLayer({
                        id: 'earthquakes-circles',
                        type: 'circle',
                        source: 'earthquakes',
                        paint: {
                            'circle-radius': [
                                'interpolate', ['linear'], ['get', 'mag'],
                                0, 2,
                                4, 6,
                                6, 12
                            ],
                            'circle-color': [
                                'interpolate', ['linear'], ['get', 'mag'],
                                0, '#fee5d9',
                                4, '#fcae91',
                                5.5, '#fb6a4a',
                                7, '#de2d26'
                            ],
                            'circle-opacity': 0.8,
                            'circle-stroke-color': '#222',
                            'circle-stroke-width': 0.5
                        }
                    });

                    // Popup for earthquakes
                    map.on('click', 'earthquakes-circles', (e) => {
                        const feat = e.features && e.features[0];
                        if (!feat) return;
                        const mag = feat.properties.mag || 'N/A';
                        const id = feat.properties.id || '';
                        const time = feat.properties.time ? new Date(feat.properties.time).toLocaleString() : '';
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`<strong>id:</strong> ${id}<br><strong>mag:</strong> ${mag}<br><strong>time:</strong> ${time}`)
                            .addTo(map);
                    });

                    map.on('mouseenter', 'earthquakes-circles', () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', 'earthquakes-circles', () => map.getCanvas().style.cursor = '');

                    // Wire toggle button
                    const toggleBtn = document.getElementById('toggleEQ');
                    let eqVisible = true;
                    toggleBtn.addEventListener('click', () => {
                        eqVisible = !eqVisible;
                        map.setLayoutProperty('earthquakes-circles', 'visibility', eqVisible ? 'visible' : 'none');
                        toggleBtn.textContent = eqVisible ? 'Hide Earthquakes' : 'Show Earthquakes';
                    });
                } catch (err) {
                    console.error('Failed to load earthquakes:', err);
                }
            });

            // Set up sort button
            const sortBtn = document.querySelector('button');
            sortBtn.addEventListener('click', sortTable);
        }

        // Start loading the data
        loadData();

        function sortTable(e) {
            let table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById('dataTable');
            switching = true;
            
            /*Make a loop that will continue until
            no switching has been done:*/
            while (switching) {
                //start by saying: no switching is done:
                switching = false;
                rows = table.rows;
                /*Loop through all table rows (except the
                first, which contains table headers):*/
                for (i = 1; i < (rows.length - 1); i++) {
                    //start by saying there should be no switching:
                    shouldSwitch = false;
                    /*Get the two elements you want to compare,
                    one from current row and one from the next:*/
                    x = parseFloat(rows[i].getElementsByTagName("td")[1].innerHTML.replace(/,/g, ''));
                    y = parseFloat(rows[i + 1].getElementsByTagName("td")[1].innerHTML.replace(/,/g, ''));
                    //check if the two rows should switch place:
                    if (x < y) {
                        //if so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    /*If a switch has been marked, make the switch
                    and mark that a switch has been done:*/
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }
    </script>
</body>
</html>